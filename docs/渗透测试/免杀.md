# 免杀

> https://github.com/TideSec/BypassAntiVirus

## 要求：

- 钓鱼木马：

	- 功能正常，伪装要好:

    - 能正常弹出你原本想让客户看到的东西，保证能正常上线，兼容大部分环境
    - 伪装：长文件名，修改exe显示的目标等

  - 短期免杀：
- 钓鱼马很容易被分析，最好是能够快速生成，保证每次文件md5与加密key都会改变，shellcode不建议远程加载。
- 维持马：
    - 长久免杀：
    - 体积小：可以使用分离免杀去减小木马体积，也可以通过劫持软件DLL。
    - 注意隐藏

## 免杀技巧

- 特征码：
- 去除特征：
    - 修改文件md5：
    - 修改敏感函数：

### 加壳免杀：

- **原理**

    - 说起软件加壳，简单地说，软件加壳其实也可以称为软件加密（或软件压缩），只是加密（或压缩）的方式与目的不一样罢了。壳就是软件所增加的保护，并不会破坏里面的程序结构，当我们运行这个加壳的程序时，系统首先会运行程序里的壳，然后由壳将加密的程序逐步还原到内存中，最后运行程序。
    - 当我们运行这个加壳的程序时，系统首先会运行程序的“壳”，然后由壳将加密的程序逐步还原到内存中，最后运行程序。这样一来，在我们看来，似乎加壳之后的程序并没有什么变化，然而它却达到了加密的目的，这就是壳的作用。
    - 加壳虽然对于特征码绕过有非常好的效果，加密壳基本上可以把特征码全部掩盖，但是缺点也非常的明显，因为壳自己也有特征。在某些比较流氓的国产杀软的检测方式下，主流的壳如VMP, Themida等，一旦被检测到加壳直接弹框告诉你这玩意儿有问题，虽然很直接，但是还是挺有效的。有些情况下，有的常见版本的壳会被直接脱掉分析。
    - 面对这种情况可以考虑用一切冷门的加密壳，有时间精力的可以基于开源的压缩壳改一些源码，效果可能会很不错。
    - 总得来说，加壳的方式来免杀还是比较实用的，特别是对于不开源的PE文件，通过加壳可以绕过很多特征码识别。

    **工具**：

    - 

    - 压缩壳，加密壳，
    - vmprotect

- 编码加密：
    - XOR：
    - AES

- 本地分离：
    - 将 shellcode与加加载器进行分离。 shellcode通过加密放置于文件中，加载器首先判断文件是指定的目录文件是否存在，如果不存在，则不做任何操作，直接退出。如果目标文件存在，则读取指定文件内容，再通过内置的ke去对文件内容进行解密，解密成功则加载 shellcode进内存，正常反弹she』l解密失败的话直接退出

- 远程分离：
    - 将 shellcode与加加载器进行分离。 shellcode通过加密放置于文件中，加载器首先判断文件是指定的目录文件是否存在，如果不存在，则不做任何操作，直接退出。如果目标文件存在，则读取指定文件内容，再通过内置的ke去对文件内容进行解密，解密成功则加载 shellcode进内存，正常反弹she』l解密失败的话直接退出

免杀工具：

- 掩日
- DarkGlD
- Foureye

杀软分析：

- ![image-20220905162259617](免杀.assets/image-20220905162259617.png)

常见问题：

- 分离免杀要考虑的向题？
    - 1.用尽可能可信的域名。例如在某些知名网站上上传含有 shellcode的图片。
    - 2.要考虑域名不解析的情况。曾遇到过因为目标机器无DNS导致域名无法解析，无法获取远程 shellcode的问题
    - 3.要考虑到P被封的情况，所以可以考虑木马使用DN方案。